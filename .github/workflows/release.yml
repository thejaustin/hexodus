name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        packages: >
          tools
          platform-tools
          build-tools;34.0.0
          platforms;android-34
          ndk;25.1.8937393
          emulator
        cmdline-tools-version: 'latest'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build Release APK
      run: ./gradlew assembleRelease --no-daemon

    - name: Sign Release APK
      uses: r0adkll/sign-android-release@v1
      if: ${{ secrets.SIGNING_KEY != '' && secrets.ALIAS != '' && secrets.KEY_STORE_PASSWORD != '' && secrets.KEY_PASSWORD != '' }}
      with:
        releaseDirectory: app/build/outputs/apk/release
        signingKeyBase64: ${{ secrets.SIGNING_KEY }}
        alias: ${{ secrets.ALIAS }}
        keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
        keyPassword: ${{ secrets.KEY_PASSWORD }}
      env:
        BUILD_TOOLS_VERSION: "34.0.0"

    - name: Set APK Path
      run: |
        if [ -f "app/build/outputs/apk/release/app-release-signed.apk" ]; then
          echo "APK_PATH=app/build/outputs/apk/release/app-release-signed.apk" >> $GITHUB_ENV
        elif [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          echo "APK_PATH=app/build/outputs/apk/release/app-release-unsigned.apk" >> $GITHUB_ENV
        else
          echo "APK_PATH=app/build/outputs/apk/release/app-release.apk" >> $GITHUB_ENV
        fi

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## What's New in Version ${{ github.ref_name }}

          This release includes:
          - Enhanced theming engine with hex color support
          - Material You override for Samsung One UI 8
          - High contrast theme injection
          - Foldable device support for Z Flip 5
          - Shizuku integration for system-level operations
          - Advanced overlay management
          - Per-app theming capabilities
          - Gesture and interaction customization
          - Media and notification customization
          - Backup and restore functionality
          - System inspection capabilities
          - Privacy and security features
          - Network management capabilities
          - Performance optimization tools

          For detailed changes, see the [full changelog](https://github.com/username/hexodus/blob/main/CHANGELOG.md).
        draft: false
        prerelease: false

    - name: Upload Release APK
      id: upload-release-apk
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ env.APK_PATH }}
        asset_name: hexodus-${{ github.ref_name }}.apk
        asset_content_type: application/vnd.android.package-archive